import os
import fonctions_utiles as fu
from adn import *

class Espece:
    def __init__(self, nom):
        self.nom=nom
        self.filles=[]

    def is_hypothetique(self):
        """
        Precise si l'espèce est hypothètique

        Args:
            self: l'espèce à verifier

        Returns:
            True si l'espèce est hypothètique, False sinon.
        """
        return not self.filles==[]

    def get_filles(self):
        """
        Retourne les espèces filles si l'espèce analysée est avérée

        Args:
            self: l'espèce à verifier

        Returns:
            La liste des espèces filles
        """
        if not self.is_hypothetique():
            raise AssertionError("Votre espèce n'a pas de filles")
        return self.filles


class EspeceAveree(Espece):
    def __init__(self, nom_fichier):
        nom=os.path.basename(nom_fichier).replace('.adn', '')
        super().__init__(nom)
        try:
            self.adn_sequence = fu.transformer_fichier(nom_fichier)
            if not self.adn_sequence:
                raise ValueError("Le fichier ADN est vide.")
        except FileNotFoundError:
            print(f"ERREUR: Le fichier {nom_fichier} n'a pas été trouvé.")
            raise
        except Exception as e:
            print(f"ERREUR lors du chargement de {nom_fichier}: {e}")
            raise

    def get_adn(self):
        """
        Retourne la séquence adn du fichier .adn liée à l'espèce

        Args:
            self: l'espèce à verifier

        Returns:
            la séquence adn de l'espèce
        """
        return self.adn_sequence
    
class EspeceHypothetique(Espece):
    def __init__(self, espece1, espece2):
        nom=f'({espece1.nom}+{espece2.nom})'
        super().__init__(nom)
        # stocker les deux espèces filles dans l'attribut attendu `filles`
        self.filles = [espece1, espece2]

    def get_adn(self):
        return None
    

def distance_especes(espece_a: Espece, espece_b: Espece)-> int: 
    """
    Calcule la distance entre les deux espèces selon si elles sont hypthètiques ou non

    Args:
        espece_a: la première espèce 
        espece_b: la deuxième espèce

    Returns:
        La distance entre les séquences adn des espèces.
    """
    if espece_a.is_hypothetique() and espece_b.is_hypothetique():
        fille1_a, fille2_a = espece_a.get_filles()
        d1=distance_especes(fille1_a, espece_b)
        d2=distance_especes(fille2_a, espece_b)
        return (d1+d2)/2
    
    elif espece_b.is_hypothetique():
        fille1_b, fille2_b=espece_b.get_filles()
        d1=distance_especes(espece_a, fille1_b)
        d2=distance_especes(espece_a, fille2_b)
        return (d1+d2)/2
    elif espece_a.is_hypothetique():
        fille1_a, fille2_a=espece_a.get_filles()
        d1=distance_especes(espece_b, fille1_a)
        d2=distance_especes(espece_b, fille2_a)
        return (d1+d2)/2
    
    else: 
        return distance_levenshtein(espece_a.get_adn(), espece_b.get_adn())
    

def creer_especes_averees(fichiers_adn):
    """
    Crée une liste d'objets EspeceAveree à partir d'une liste de noms de fichiers.
    """
    especes = []
    for fichier in fichiers_adn:
        # `fichier` doit être le nom/chemin du fichier .adn ; laisser
        # à EspeceAveree le soin d'ouvrir et transformer le fichier
        especes.append(EspeceAveree(fichier))
    return especes

def reconstruction_arbre_phylogenetique(fichiers_adn):
    """
    Implémente la reconstruction d'un arbre phylogénétique (méthode UPGMA) 
    à partir des distances de Levenshtein.

    Args:
        fichiers_adn: Liste des noms de fichiers ADN des espèces avérées.

    Returns:
        L'objet Espece (Hypothetique) représentant la racine de l'arbre final, 
        ou la seule espèce s'il n'y en avait qu'une au départ.
    """
    especes_restantes = creer_especes_averees(fichiers_adn)

    if len(especes_restantes) < 2:
        if len(especes_restantes) == 1:
             print(f"Arbre terminé : Seulement l'espèce {especes_restantes[0].nom}.")
             return especes_restantes[0]
        else:
             print("Aucune espèce avérée trouvée pour la reconstruction.")
             return None
    while len(especes_restantes) > 1:
        distance_min = float('inf')
        paire_a_regrouper = None
        for i in range(len(especes_restantes)):
            for j in range(i + 1, len(especes_restantes)):
                esp_a = especes_restantes[i]
                esp_b = especes_restantes[j]
                dist = distance_especes(esp_a, esp_b)
                if dist < distance_min:
                    distance_min = dist
                    paire_a_regrouper = (i, j)
        idx_a, idx_b = paire_a_regrouper
        if idx_a > idx_b:
            idx_a, idx_b = idx_b, idx_a
        
        esp_a = especes_restantes[idx_a]
        esp_b = especes_restantes[idx_b]
        print(f"Regroupement : {esp_a.nom} et {esp_b.nom} (Distance: {distance_min:.2f})")

        nouvel_ancetre = EspeceHypothetique(esp_a, esp_b)
        especes_restantes.pop(idx_b)
        especes_restantes.pop(idx_a) 
        especes_restantes.append(nouvel_ancetre)
        
        print(f"Espèces restantes : {[e.nom for e in especes_restantes]}")
    return especes_restantes[0]