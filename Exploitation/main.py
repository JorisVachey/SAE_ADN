import sys
import os
from adn import *
from phylogenie import *
from fonctions_utiles import *

def menu():
    """Affiche le menu interactif avec les options disponibles."""
    menu = """
===================================================
 Système d'Analyse et de Mutation d'ADN (Interactif)
===================================================

 Commandes disponibles:
 ---------------------
 1. generer_adn (Générer une séquence ADN aléatoire) param : <nom> <longueur>
 2. mutations (Appliquer des remplacements, délétions et insertions) param : <fichier_entree> <proba_remplacement> <proba_deletion> <proba_insertion>
 3. distance_remplacement (Calculer la distance par remplacement) param : <fichier_adn1> <fichier_adn2>
 4. distance_levenshtein (Calculer la distance de Levenshtein) param : <fichier_adn1> <fichier_adn2>
 5. distance_especes (Calculer la distance de Levenshtein entre deux espèces) param : <fichier_adn1> <fichier_adn2>
 6. reconstruire_arbre_phylogenetique(Construit l'arbre des espèces) param : <liste de noms> <taille des fichiers>
 7. Aide (Afficher le détail des commandes)
 8. Quitter
 ---------------------
 Entrez le numéro de la commande que vous souhaitez exécuter: 
"""
    print(menu, end="")

def aide():
    """Affiche les commandes disponibles et leur usage."""
    help_text = """
--- Aide détaillée des commandes ---
1.  **generer_adn** <nom> <longueur>
    * Génère une séquence ADN aléatoire de la longueur spécifiée dans un fichier <nom>.adn.
    * Exemple: `sequence1 1000`

2.  **mutations** <fichier_entree> <proba_remplacement> <proba_deletion> <proba_insertion>
    * Applique une série de mutations. Probabilités entre 0.0 et 1.0.
    * Exemple: `sequence1.adn 0.05 0.01 0.02`

3.  **distance_remplacement** <fichier_adn1> <fichier_adn2>
    * Calcule la distance de remplacement (même longueur requise).
    * Exemple: `seq1.adn seq2.adn`

4.  **distance_levenshtein** <fichier_adn1> <fichier_adn2>
    * Calcule la distance de Levenshtein (supporte les longueurs différentes).
    * Exemple: `seq_a.adn seq_b.adn`

5.  **distance_especes** <fichier_adn1> <fichier_adn2>
    * Calcule la distance de Levenshtein entre deux espèces avérées.
    * Exemple: `humain.adn chimpanze.adn`

6.  **reconstruire_arbre_phylogenetique** <liste de noms> <taille des fichiers>
    * Construit un arbre phylogenetique selon les fichiers adn des espèces données.
    * Exemple: `["chien", "chat"] 150`
------------------------------------
"""
    print(help_text)

def commandes(commande_id, param):
    """Exécute la fonction correspondant à la commande en utilisant l'ID."""
    
    num_commandes = {
        1: 'generer_adn',
        2: 'mutations',
        3: 'distance_remplacement',
        4: 'distance_levenshtein',
        5: 'distance_especes',
        6: 'reconstruire_arbre_phylogenetique'
    }

    commande = num_commandes.get(commande_id)
    if not commande:
        print(f"ERREUR: ID de commande '{commande_id}' invalide.")
        return

    # --- 1. generer_adn ---
    if commande_id == 1:
        if len(param) != 2:
            print("ERREUR: Commande 'generer_adn' nécessite 2 arguments: <nom> <longueur>")
            return
        try:
            nom_fichier = param[0]
            longueur = int(param[1])
            if longueur <= 0:
                raise ValueError("La longueur doit être positive.")
            print(f"Génération d'ADN: Fichier={nom_fichier}.adn, Longueur={longueur}")
            generer_adn(nom_fichier, longueur)
        except Exception as e:
            print(f"Une erreur s'est produite lors de la génération: {e}")

    # --- 2. mutations ---
    elif commande_id == 2:
        if len(param) != 4:
            print("ERREUR: Commande 'mutations' nécessite 4 arguments: <fichier> <proba_r> <proba_d> <proba_i>")
            return
        try:
            nom_fichier = param[0]
            proba_r = float(param[1])
            proba_d = float(param[2])
            proba_i = float(param[3])

            if not 0.0 <= proba_r <= 1.0 or not 0.0 <= proba_d <= 1.0 or not 0.0 <= proba_i <= 1.0:
                 raise ValueError("Les probabilités doivent être entre 0.0 et 1.0.")

            print(f"Application des mutations sur {nom_fichier}...")
            print(f" Remplacement: {proba_r*100:.2f}%, Deletion: {proba_d*100:.2f}%, Insertion: {proba_i*100:.2f}%")
            
            resultat = mutations(nom_fichier, proba_r, proba_d, proba_i)
            print(f"Opération 'mutations' terminée. Fichier final: {resultat}")
            
        except FileNotFoundError:
             print(f"ERREUR: Le fichier d'entrée '{nom_fichier}' n'existe pas.")
        except Exception as e:
            print(f"Une erreur s'est produite lors de la mutation: {e}")

    # --- 3. distance_remplacement ---
    elif commande_id == 3:
        if len(param) != 2:
            print("ERREUR: Commande 'distance_remplacement' nécessite 2 arguments: <fichier1> <fichier2>")
            return
        
        adn1_name, adn2_name = param[0], param[1]
        print(f"Calcul de la distance de remplacement entre {adn1_name} et {adn2_name}...")
        
        resultat = distance_remplacement_chaine(adn1_name, adn2_name)
        
        if isinstance(resultat, str) and resultat.startswith("Le fichier"):
            print(f"ERREUR: {resultat}")
        else:
            print(f"Distance de Remplacement: {resultat}")


    # --- 4. distance_levenshtein ---
    elif commande_id == 4:
        if len(param) != 2:
            print("ERREUR: Commande 'distance_levenshtein' nécessite 2 arguments: <fichier1> <fichier2>")
            return
        
        adn1_name, adn2_name = param[0], param[1]
        print(f"Calcul de la distance de Levenshtein entre {adn1_name} et {adn2_name}...")
        
        resultat = distance_levenshtein(adn1_name, adn2_name)
        
        if isinstance(resultat, str) and resultat.startswith("Le fichier"):
            print(f"ERREUR: {resultat}")
        else:
            print(f"Distance de Levenshtein: {int(resultat)}")


    # --- 5. distance_especes ---
    elif commande_id == 5:
        if len(param) != 2:
            print("ERREUR: Commande 'distance_especes' nécessite 2 arguments: <fichier1> <fichier2>")
            return
        
        adn1_name, adn2_name = param[0], param[1]
        
        try:
            espece_a = EspeceAveree(adn1_name)
            espece_b = EspeceAveree(adn2_name)
            
            print(f"Calcul de la distance entre les espèces {espece_a.nom} et {espece_b.nom} (via Levenshtein)...")
            resultat = distance_especes(espece_a, espece_b)
            print(f"Distance entre les deux espèces: {int(resultat)}")

        except FileNotFoundError:
            print(f"ERREUR: Le fichier d'entrée '{adn1_name}'ou '{adn2_name} n'existe pas.")
        except Exception as e:
            print(f"Une erreur s'est produite: {e}")

    
    # --- 6. reconstruire_arbre_phylogenetique ---

    elif commande_id == 6:
        if len(param) < 3:
            print("ERREUR: Commande 'reconstruire_arbre_phylogenetique' nécessite au moins 2 String, la longueur des adn ")
            return  
        
        noms_especes = []
        for p in range(len(param)-1):
            noms_especes.append(param[p])

        longueur_adn_test =int (param[len(param)-1])
        especes_averees = []
        
        try :
            
            print(f"--- Démarrage du test simple de l'arbre ({len(noms_especes)} espèces) ---")
            print(f"Génération de {len(noms_especes)} fichiers ADN (longueur {longueur_adn_test})...")
            print(noms_especes)
            print(longueur_adn_test)

            for nom in noms_especes:

                print(f"Génération de {nom}.adn...")
                generer_adn(nom, longueur_adn_test) 
                print("a")
                nom_fichier_adn = f"{nom}.adn"
                print("b")
                espece_obj = EspeceAveree(nom_fichier_adn)
                print("c")
                especes_averees.append(espece_obj)
                print("d")

            print(f"\n{len(especes_averees)} espèces avérées créées avec succès.")

            print("\n--- Lancement de la reconstruction de l'arbre ---")

            if len(especes_averees) >= 2:
                racine = reconstruire_arbre_phylogenetique(especes_averees)
                
                print("\n===================================")
                print("      ARBRE RECONSTRUIT            ")
                print("===================================")
                print(visualiser_arbre(racine))
                print("===================================")
                
            else:
                print("Pas assez d'espèces (minimum 2) pour construire un arbre.")

            print("\n--- Test simple terminé ---")

        except Exception as e:
            print(f"Une erreur s'est produite: {e}")

# --- Boucle interactive principale ---
def main_interactive():
    while True:
        menu()
        choix = input().strip()
        
        if choix == '8':
            print("Merci d'avoir utilisé le système. Au revoir !")
            break
        
        if choix == '7':
            aide()
            continue

        try:
            commande_id = int(choix)
            if commande_id < 1 or commande_id > 6:
                raise ValueError
        except ValueError:
            print("Choix invalide. Veuillez entrer un numéro de 1 à 8.")
            continue

        param_input = input(f"Veuillez entrer les arguments pour la commande {commande_id} (séparés par un espace) : ")
        param = param_input.split()
        
        print("\n--- Exécution de la commande ---")
        commandes(commande_id, param)
        print("--- Commande terminée ---\n")


if __name__ == "__main__":
    main_interactive()